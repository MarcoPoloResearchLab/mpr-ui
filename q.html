<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>mpr-quadrant-stepper (click-to-quadrant)</title>

<script>
class MprQuadrantStepper extends HTMLElement {
  static get observedAttributes() { return ["value", "size"]; }

  constructor() {
    super();
    this._value = 0;
    this._names = ["top-left","top-right","bottom-right","bottom-left"];

    const shadowRoot = this.attachShadow({ mode: "open" });
    shadowRoot.innerHTML = `
      <style>
        :host {
          --qp-size: 40px;
          --qp-dot: #000;
          --qp-border: #9aa0a6;
          display: inline-block;
        }
        button.wrapper {
          all: unset;
          box-sizing: content-box;
          inline-size: var(--qp-size);
          block-size: var(--qp-size);
          display: inline-block;
          border: 1px solid var(--qp-border);
          border-radius: 6px;
          padding: 6px;
          cursor: pointer;
        }
        button.wrapper:focus-visible {
          outline: 2px solid #1a73e8;
          outline-offset: 2px;
        }
        .grid {
          position: relative;
          inline-size: 100%;
          block-size: 100%;
          display: grid;
          grid-template-columns: 1fr 1fr;
          grid-template-rows: 1fr 1fr;
        }
        .quad {
          position: relative;
        }
        .quad.tl { background: #ffffff; }
        .quad.tr { background: #ffeb3b; }
        .quad.br { background: #001133; }
        .quad.bl { background: #c5f5b0; }
        .grid::before,
        .grid::after {
          content: "";
          position: absolute;
          pointer-events: none;
          background: var(--qp-border);
        }
        .grid::before {
          width: 1px;
          height: 100%;
          left: 50%;
          transform: translateX(-0.5px);
        }
        .grid::after {
          height: 1px;
          width: 100%;
          top: 50%;
          transform: translateY(-0.5px);
        }
        .dot {
          position: absolute;
          inline-size: 8px;
          block-size: 8px;
          background: var(--qp-dot);
          border-radius: 50%;
          left: calc(var(--col, 0) * 50% + 25%);
          top:  calc(var(--row, 0) * 50% + 25%);
          transform: translate(-50%, -50%);
          transition: left 150ms ease, top 150ms ease, background-color 100ms ease;
        }
      </style>
      <button class="wrapper" type="button" aria-live="polite">
        <div class="grid">
          <div class="quad tl"></div>
          <div class="quad tr"></div>
          <div class="quad bl"></div>
          <div class="quad br"></div>
          <div class="dot"></div>
        </div>
      </button>
    `;

    this._buttonElement = shadowRoot.querySelector("button.wrapper");
    this._gridElement = shadowRoot.querySelector(".grid");
    this._dotElement = shadowRoot.querySelector(".dot");

    this._onClick = (clickEvent) => this._handlePointerClick(clickEvent);
    this._onKeyDown = (keyboardEvent) => {
      if (keyboardEvent.key === " " || keyboardEvent.key === "Enter") {
        keyboardEvent.preventDefault();
        this.next();
      }
    };
  }

  connectedCallback() {
    if (!this.hasAttribute("size")) {
      this.style.setProperty("--qp-size", "40px");
    }
    this._buttonElement.addEventListener("click", this._onClick);
    this._buttonElement.addEventListener("keydown", this._onKeyDown);
    this._render();
  }

  disconnectedCallback() {
    this._buttonElement.removeEventListener("click", this._onClick);
    this._buttonElement.removeEventListener("keydown", this._onKeyDown);
  }

  attributeChangedCallback(attributeName, previousValue, nextValue) {
    if (previousValue === nextValue) {
      return;
    }
    if (attributeName === "value") {
      const parsedIndexValue = Number(nextValue);
      if (Number.isInteger(parsedIndexValue) && parsedIndexValue >= 0 && parsedIndexValue <= 3) {
        this._value = parsedIndexValue;
        this._render();
      }
    } else if (attributeName === "size") {
      const rawSizeValue = String(nextValue).trim();
      const normalizedSizeValue = /^\d+$/.test(rawSizeValue) ? `${rawSizeValue}px` : rawSizeValue;
      this.style.setProperty("--qp-size", normalizedSizeValue);
    }
  }

  get value() {
    return this._value;
  }

  set value(nextIndexValue) {
    const numericIndexValue = Math.max(0, Math.min(3, Number(nextIndexValue)));
    if (numericIndexValue !== this._value) {
      this._value = numericIndexValue;
      this.setAttribute("value", String(numericIndexValue));
      this._render();
      this._emit();
    }
  }

  next() {
    this.value = (this._value + 1) % 4;
  }

  reset() {
    this.value = 0;
  }

  _handlePointerClick(clickEvent) {
    const gridBoundingRectangle = this._gridElement.getBoundingClientRect();
    const relativeHorizontalPosition = clickEvent.clientX - gridBoundingRectangle.left;
    const relativeVerticalPosition = clickEvent.clientY - gridBoundingRectangle.top;

    const isRightHalf = relativeHorizontalPosition >= gridBoundingRectangle.width / 2;
    const isBottomHalf = relativeVerticalPosition >= gridBoundingRectangle.height / 2;

    let targetIndex = 0;
    if (!isBottomHalf && !isRightHalf) {
      targetIndex = 0; // top-left
    } else if (!isBottomHalf && isRightHalf) {
      targetIndex = 1; // top-right
    } else if (isBottomHalf && isRightHalf) {
      targetIndex = 2; // bottom-right
    } else {
      targetIndex = 3; // bottom-left
    }

    this.value = targetIndex;
  }

  _render() {
    const columnIndexByValue = [0, 1, 1, 0];
    const rowIndexByValue = [0, 0, 1, 1];

    this._dotElement.style.setProperty("--col", columnIndexByValue[this._value]);
    this._dotElement.style.setProperty("--row", rowIndexByValue[this._value]);

    if (this._value === 2) {
      this._dotElement.style.backgroundColor = "#ffffff";
    } else {
      this._dotElement.style.backgroundColor = "#000000";
    }

    this._buttonElement.setAttribute(
      "aria-label",
      `Quadrant stepper, dot in ${this._names[this._value]}`
    );
  }

  _emit() {
    const detailPayload = { index: this._value, name: this._names[this._value] };
    this.dispatchEvent(new CustomEvent("quadrant-change", { detail: detailPayload, bubbles: true }));
    this.dispatchEvent(new CustomEvent("change", { detail: detailPayload, bubbles: true }));
  }
}

customElements.define("mpr-quadrant-stepper", MprQuadrantStepper);
</script>

<body>
  <mpr-quadrant-stepper id="stepper" size="64"></mpr-quadrant-stepper>

  <script>
    const stepperElement = document.getElementById("stepper");
    stepperElement.addEventListener("quadrant-change", (eventObject) => {
      console.log("Changed:", eventObject.detail);
    });
  </script>
</body>
</html>
