<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Standalone Login Button + TAuth</title>
    <link rel="stylesheet" href="./mpr-ui.css" />
    <link rel="stylesheet" href="./demo.css" />
    <script defer src="./standalone-config.js"></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/module.esm.js"
      type="module"
    ></script>
    <!-- TAuth helper proxied through ghttp for same-origin operation -->
    <script defer src="/tauth.js"></script>
    <script id="mpr-ui-bundle" defer src="./mpr-ui.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body {
        background: var(--mpr-color-surface-primary, #f8fafc);
        color: var(--mpr-color-text-primary, #0f172a);
        min-height: 100vh;
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .page-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      main {
        flex: 1;
        max-width: 720px;
        margin: 0 auto;
        padding: 3rem 1.5rem;
      }
      h1 {
        margin: 0 0 0.5rem;
        font-size: 2rem;
      }
      .subtitle {
        color: var(--mpr-color-text-muted, #64748b);
        margin: 0 0 2.5rem;
        font-size: 1.1rem;
      }
      .auth-section {
        margin-bottom: 2.5rem;
        position: relative;
        z-index: 20;
      }
      .auth-section h2 {
        font-size: 1.25rem;
        margin: 0 0 1rem;
      }
      /* Auth card using mpr-ui design tokens */
      .auth-card {
        border: 1px solid var(--mpr-color-border, rgba(148,163,184,0.35));
        border-radius: 0.75rem;
        padding: 1.5rem;
        background: var(--mpr-color-surface-elevated, #ffffff);
        box-shadow: var(--mpr-shadow-elevated, 0 8px 16px rgba(15,23,42,0.18));
      }
      /* Sign-in state */
      .auth-card__signin {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        text-align: center;
      }
      .auth-card__signin p {
        margin: 0;
        color: var(--mpr-color-text-muted, #64748b);
      }
      .auth-card__signin mpr-login-button {
        margin-top: 0.5rem;
      }
      /* Session state */
      .auth-card__session {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }
      .auth-card__profile {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
        min-width: 0;
      }
      .auth-card__avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--mpr-color-border, rgba(148,163,184,0.35));
        flex-shrink: 0;
      }
      .auth-card__info {
        min-width: 0;
      }
      .auth-card__name {
        font-weight: 600;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .auth-card__email {
        margin: 0.25rem 0 0;
        font-size: 0.875rem;
        color: var(--mpr-color-text-muted, #64748b);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .auth-card__menu {
        flex-shrink: 0;
      }
      /* Session info card */
      .session-section {
        margin-top: 2.5rem;
      }
      .session-section h2 {
        font-size: 1.25rem;
        margin: 0 0 1rem;
      }
      .session-card {
        border: 1px solid var(--mpr-color-border, rgba(148,163,184,0.35));
        border-radius: 0.75rem;
        padding: 1.5rem;
        background: var(--mpr-color-surface-elevated, #ffffff);
        box-shadow: var(--mpr-shadow-elevated, 0 8px 16px rgba(15,23,42,0.18));
      }
      .session-card h3 {
        margin: 0 0 0.5rem;
        font-size: 1.1rem;
      }
      .session-card p {
        margin: 0;
        color: var(--mpr-color-text-muted, #64748b);
      }
      .session-card__profile {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      .session-card__profile ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .session-card__profile li + li {
        margin-top: 0.25rem;
      }
      .session-card__avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--mpr-color-border, rgba(148,163,184,0.35));
      }
      .session-card__expires {
        margin-top: 1rem;
        font-size: 0.95rem;
        color: var(--mpr-color-text-muted, #64748b);
      }
      .info-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid var(--mpr-color-border, rgba(148,163,184,0.35));
      }
      .info-section h2 {
        font-size: 1.25rem;
        margin: 0 0 1rem;
      }
      .info-section ul {
        padding-left: 1.25rem;
        color: var(--mpr-color-text-muted, #64748b);
      }
      .info-section li + li {
        margin-top: 0.5rem;
      }
      .info-section code {
        background: var(--mpr-chip-bg, rgba(148,163,184,0.18));
        padding: 0.15rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.9em;
      }
      [hidden] {
        display: none !important;
      }
    </style>
  </head>
  <body data-mpr-theme="light">
    <div class="page-container">
      <main>
        <h1>Standalone Login Button</h1>
        <p class="subtitle">
          Using <code>&lt;mpr-login-button&gt;</code> and
          <code>&lt;mpr-user&gt;</code> without the header component.
        </p>

        <section class="auth-section">
          <h2>Authentication</h2>
          <div class="auth-card" aria-live="polite" aria-atomic="true">
            <!-- Sign-in state -->
            <div class="auth-card__signin" id="signin-content">
              <p>Click the button below to sign in with Google via TAuth.</p>
              <mpr-login-button
                id="demo-login-button"
                button-size="small"
                button-shape="circle"
                site-id="991677581607-r0dj8q6irjagipali0jpca7nfp8sfj9r.apps.googleusercontent.com"
                tauth-tenant-id="mpr-sites"
                tauth-login-path="/auth/google"
                tauth-logout-path="/auth/logout"
                tauth-nonce-path="/auth/nonce"
              ></mpr-login-button>
            </div>
            <!-- Session state -->
            <div class="auth-card__session" id="session-content" hidden>
              <div class="auth-card__profile">
                <img class="auth-card__avatar" id="session-avatar" src="" alt="Profile" />
                <div class="auth-card__info">
                  <p class="auth-card__name" id="session-name"></p>
                  <p class="auth-card__email" id="session-email"></p>
                </div>
              </div>
              <div class="auth-card__menu">
                <mpr-user
                  id="demo-user-menu"
                  display-mode="avatar"
                  tauth-tenant-id="mpr-sites"
                  logout-url="/"
                  logout-label="Sign out"
                  menu-items='[{"label":"Account","href":"#account"},{"label":"Settings","action":"open-settings"}]'
                ></mpr-user>
              </div>
            </div>
          </div>
        </section>

        <section class="session-section">
          <h2>Session Details</h2>
          <div
            class="session-card"
            data-demo-auth-status
            aria-live="polite"
            aria-atomic="true"
          >
            <h3>Signed out</h3>
            <p>Use the Google Sign-In button above to begin.</p>
          </div>
        </section>

        <section class="info-section">
          <h2>How this demo works</h2>
          <ul>
            <li>
              <code>&lt;mpr-login-button&gt;</code> renders the Google Sign-In
              button via GIS and handles the credential exchange with TAuth.
            </li>
            <li>
              <code>&lt;mpr-user&gt;</code> displays the authenticated profile
              and provides a dropdown with menu items and logout action.
            </li>
            <li>
              Both components listen for <code>mpr-ui:auth:*</code> events to
              stay in sync with the session state.
            </li>
            <li>
              TAuth endpoints (<code>/auth/nonce</code>,
              <code>/auth/google</code>, <code>/auth/logout</code>) handle the
              backend exchange.
            </li>
            <li>
              This pattern is useful for login pages, sidebars, or anywhere you
              need auth controls without the full header.
            </li>
          </ul>
        </section>
      </main>

      <mpr-footer
        id="page-footer"
        prefix-text="Built by Marco Polo Research Lab"
        privacy-link-label="Privacy &amp; Terms"
        privacy-link-href="#privacy"
        links-collection='{
          "style": "drop-up",
          "text": "More demos",
          "links": [
            { "label": "TAuth Demo", "url": "/demo/tauth-demo.html" },
            { "label": "Local Demo", "url": "/demo/local.html" },
            { "label": "Index Demo", "url": "/demo/index.html" }
          ]
        }'
        theme-switcher="toggle"
        theme-config='{"attribute":"data-mpr-theme","targets":["body"],"initialMode":"light","modes":[{"value":"light","attributeValue":"light"},{"value":"dark","attributeValue":"dark"}]}'
      ></mpr-footer>
    </div>

    <script defer src="./status-panel.js"></script>
    <script>
      (function() {
        // Apply TAUTH_DEMO_CONFIG to standalone elements
        function applyConfig() {
          var config = window.TAUTH_DEMO_CONFIG || {};
          var loginButton = document.getElementById('demo-login-button');
          var userMenu = document.getElementById('demo-user-menu');
          if (loginButton) {
            if (config.googleClientId) loginButton.setAttribute('site-id', config.googleClientId);
            if (config.tauthUrl) loginButton.setAttribute('tauth-url', config.tauthUrl);
            if (config.tenantId) loginButton.setAttribute('tauth-tenant-id', config.tenantId);
          }
          if (userMenu && config.tenantId) {
            userMenu.setAttribute('tauth-tenant-id', config.tenantId);
          }
        }

        // Update session display with user info
        function updateSessionDisplay(profile) {
          var avatar = document.getElementById('session-avatar');
          var name = document.getElementById('session-name');
          var email = document.getElementById('session-email');
          if (avatar && profile) {
            avatar.src = profile.avatar_url || '';
            avatar.alt = profile.display || 'Profile';
          }
          if (name) name.textContent = profile ? profile.display : '';
          if (email) email.textContent = profile ? profile.user_email : '';
        }

        // Toggle visibility based on auth state
        function updateAuthVisibility(isAuthenticated, profile) {
          var signinContent = document.getElementById('signin-content');
          var sessionContent = document.getElementById('session-content');
          if (signinContent) signinContent.hidden = isAuthenticated;
          if (sessionContent) sessionContent.hidden = !isAuthenticated;
          if (isAuthenticated && profile) {
            updateSessionDisplay(profile);
          }
        }

        function init() {
          applyConfig();
          var currentUser = typeof window.getCurrentUser === 'function' ? window.getCurrentUser() : null;
          updateAuthVisibility(Boolean(currentUser), currentUser);

          document.addEventListener('mpr-ui:auth:authenticated', function(event) {
            var profile = event.detail && event.detail.profile;
            updateAuthVisibility(true, profile);
          });
          document.addEventListener('mpr-ui:auth:unauthenticated', function() {
            updateAuthVisibility(false, null);
          });
          document.addEventListener('mpr-user:menu-item', function(event) {
            if (event.detail && event.detail.action === 'open-settings') {
              alert('Settings action triggered! Wire your own modal here.');
            }
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
  </body>
</html>
