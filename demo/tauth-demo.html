<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TAuth + mpr-ui (Docker Compose)</title>
    <link
      rel="stylesheet"
      href="./mpr-ui.css"
    />
    <link rel="stylesheet" href="./demo.css" />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/module.esm.js"
      type="module"
    ></script>
    <script defer src="https://tauth.mprlab.com/tauth.js"></script>
    <script id="mpr-ui-bundle" defer src="./mpr-ui.js"></script>
    <script defer src="./mpr-ui-config.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      :root {
        --card-background: rgba(255, 255, 255, 0.9);
        --card-border: rgba(0, 0, 0, 0.1);
      }
      body.theme-dark {
        --card-background: rgba(18, 21, 23, 0.8);
        --card-border: rgba(255, 255, 255, 0.2);
      }
      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem 3rem;
      }
      .demo-section {
        margin-top: 2rem;
      }
      .session-card {
        border: 1px solid var(--card-border);
        border-radius: 0.75rem;
        padding: 1.25rem;
        background: var(--card-background);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      .session-card__profile {
        display: flex;
        gap: 1rem;
        align-items: center;
      }
      .session-card__profile ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .session-card__profile li + li {
        margin-top: 0.25rem;
      }
      .session-card__avatar {
        width: 56px;
        height: 56px;
        border-radius: 999px;
        object-fit: cover;
      }
      .session-card__expires {
        margin-top: 1rem;
        font-size: 0.95rem;
        color: var(--mpr-color-text-muted, #555);
      }
      .logout-button {
        margin-top: 1rem;
        border: 0;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
        background: #0c67ff;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      .logout-button:hover {
        background: #0842a8;
      }
      .demo-modal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 2000;
      }
      .demo-modal[hidden] {
        display: none;
      }
      .demo-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
      }
      .demo-modal__dialog {
        position: relative;
        width: min(90vw, 540px);
        border-radius: 1rem;
        border: 1px solid var(--mpr-color-border, rgba(148, 163, 184, 0.25));
        background: var(--mpr-color-surface-elevated, rgba(15, 23, 42, 0.95));
        color: var(--mpr-color-text-primary, #e2e8f0);
        box-shadow: var(--mpr-shadow-flyout, 0 24px 48px rgba(15, 23, 42, 0.45));
        padding: 1.5rem;
      }
      .demo-modal__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }
      .demo-modal__title {
        margin: 0;
        font-size: 1.25rem;
      }
      .demo-modal__close {
        border: 0;
        border-radius: 999px;
        padding: 0.4rem 0.85rem;
        background: var(--mpr-chip-bg, rgba(148, 163, 184, 0.2));
        color: inherit;
        cursor: pointer;
        font-weight: 600;
      }
      .demo-modal__close:hover {
        background: var(--mpr-chip-hover-bg, rgba(148, 163, 184, 0.32));
      }
      .demo-modal__body {
        margin-top: 1rem;
        color: var(--mpr-color-text-muted, #cbd5f5);
      }
      ol {
        padding-left: 1.25rem;
      }
      ol li + li {
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body class="theme-light" data-demo-palette="default">
    <!-- Auth attributes (google-site-id, tauth-tenant-id, tauth-*-path) applied by mpr-ui-config.js -->
    <mpr-header
      id="demo-header"
      brand-label="Marco Polo Research Lab"
      brand-href="https://mprlab.com/"
      nav-links='[
        { "label": "Docs", "href": "https://github.com/MarcoPoloResearchLab/mpr-ui/blob/master/README.md" },
        { "label": "Architecture", "href": "https://github.com/MarcoPoloResearchLab/mpr-ui/blob/master/ARCHITECTURE.md" }
      ]'
      logout-url="/"
      sign-out-label="Log out"
    >
      <!-- tauth-tenant-id applied by mpr-ui-config.js -->
      <mpr-user
        slot="aux"
        display-mode="avatar"
        logout-url="/"
        logout-label="Log out"
        menu-items='[{"label":"Settings","action":"open-settings"}]'
      ></mpr-user>
    </mpr-header>
    <main>
      <h1>TAuth demo</h1>
      <p>
        This page connects the <code>mpr-header</code> web component to a local
        TAuth service running under Docker Compose. Sign in with Google, observe
        the authenticated profile state, and use the header profile menu to
        clear your session.
      </p>

      <section aria-labelledby="profile-status-title" class="demo-section">
        <h2 id="profile-status-title">Current session</h2>
        <p>
          Google sign-in requests are exchanged via the TAuth service configured
          in <code>/config.yaml</code>. The helper script provided by TAuth
          monitors <code>/me</code> and <code>/auth/refresh</code> to keep a
          valid browser session without storing tokens in localStorage.
        </p>
        <div
          class="session-card"
          data-demo-auth-status
          aria-live="polite"
          aria-atomic="true"
        >
          <p>Awaiting connection to the TAuth service…</p>
        </div>
      </section>

      <section aria-labelledby="instructions-title" class="demo-section">
        <h2 id="instructions-title">How it works</h2>
        <ol>
          <li>
            The frontend is served by gHTTP on port 4443 (HTTPS).
          </li>
          <li>
            Auth configuration is loaded from <code>/config.yaml</code>
            via the <code>mpr-ui-config.js</code> loader, which applies
            attributes (<code>google-site-id</code>, <code>tauth-tenant-id</code>,
            <code>tauth-url</code>, etc.) to <code>&lt;mpr-header&gt;</code> and
            <code>&lt;mpr-user&gt;</code> elements.
          </li>
          <li>
            The header component requests <code>/auth/nonce</code> before
            rendering the Google button and exchanges the returned credential via
            <code>/auth/google</code>.
          </li>
          <li>
            The CDN-hosted <code>tauth.js</code> helper refreshes sessions by
            calling <code>/auth/refresh</code> whenever a request returns 401.
          </li>
          <li>
            Clicking <strong>Log out</strong> in the menu invokes
            <code>/auth/logout</code> and resets the profile snapshot below.
          </li>
        </ol>
      </section>
    </main>

    <div
      id="demo-settings-modal"
      class="demo-modal"
      hidden
      aria-hidden="true"
    >
      <div class="demo-modal__backdrop" data-demo-settings-close></div>
      <div
        class="demo-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="demo-settings-title"
      >
        <div class="demo-modal__header">
          <h2 class="demo-modal__title" id="demo-settings-title">Settings</h2>
          <button
            type="button"
            class="demo-modal__close"
            data-demo-settings-close
          >
            Close
          </button>
        </div>
        <div class="demo-modal__body">
          <p>
            This modal opens from the user menu action item. Wire your own
            settings panel here.
          </p>
        </div>
      </div>
    </div>

    <mpr-footer
      id="page-footer"
      prefix-text="Built by Marco Polo Research Lab"
      privacy-link-label="Privacy &amp; Terms"
      privacy-link-href="#privacy"
      privacy-modal-content="
        <h1>Privacy Policy — TAuth demo</h1>
        <p><strong>Effective Date:</strong> 2025-10-11</p>
        <p>The local demo exchanges your Google profile with a self-hosted TAuth instance.</p>
        <p>No data leaves your machine, and session cookies are cleared when you stop the Compose stack.</p>
      "
      links-collection='{
        "style": "drop-up",
        "text": "Explore more demos",
        "links": [
          { "label": "Marco Polo Research Lab", "url": "https://mprlab.com" },
          { "label": "LoopAware", "url": "https://loopaware.mprlab.com" },
          { "label": "Gravity Notes", "url": "https://gravity.mprlab.com" },
          { "label": "Allergy Wheel", "url": "https://allergy.mprlab.com" },
          { "label": "Countdown Calendar", "url": "https://countdown.mprlab.com" }
        ]
      }'
      theme-switcher="square"
      theme-config='{"attribute":"data-demo-theme","targets":["body"],"initialMode":"default-light","modes":[{"value":"default-light","attributeValue":"light","classList":["theme-light"],"dataset":{"data-demo-palette":"default"}},{"value":"sunrise-light","attributeValue":"light","classList":["theme-light"],"dataset":{"data-demo-palette":"sunrise"}},{"value":"default-dark","attributeValue":"dark","classList":["theme-dark"],"dataset":{"data-demo-palette":"default"}},{"value":"forest-dark","attributeValue":"dark","classList":["theme-dark"],"dataset":{"data-demo-palette":"forest"}}]}'
    ></mpr-footer>
    <script defer src="./tauth-settings-modal.js"></script>
    <script defer src="./status-panel.js"></script>
    <script>
      // Apply YAML configuration to mpr-ui components
      (function initYamlConfig() {
        function applyConfig() {
          if (!window.MPRUI || !window.MPRUI.applyYamlConfig) {
            // mpr-ui-config.js not loaded yet, retry
            setTimeout(applyConfig, 50);
            return;
          }
          window.MPRUI.applyYamlConfig({ configUrl: '/config.yaml' }).catch(function handleError(error) {
            // eslint-disable-next-line no-console
            console.error('Failed to apply YAML config:', error);
          });
        }
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', applyConfig);
        } else {
          applyConfig();
        }
      })();
    </script>
  </body>
</html>
